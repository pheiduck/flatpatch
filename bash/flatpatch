# Copyright (c) Philip H.
#!/usr/bin/env sh

# Define colors
YELLOW='\033[1;33m'
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

# Check Privileges
if [ "$(id -u)" -ne 0 ]; then
  printf "${YELLOW}WARNING:${NC} Please run with sudo privileges.\n"
  exit 1
fi

# Check OS
if [ "$(grep -E '^ID=ubuntu$' /etc/os-release)" = "" ]; then
  printf "${RED}ERROR:${NC} You are trying to install this on an unsupported distribution.\nOnly Ubuntu is supported.\n"
  exit 1
fi

# Uninstall all snap packages
printf "${RED}Uninstalling all Snap packages...${NC}\n"
for snap_package in $(snap list | awk 'NR>1 {print $1}'); do
  snap remove --purge "$snap_package"
done

# Prevent Snap from being installed by APT
printf "${RED}Disabling Snap installation via APT...${NC}\n"
cat > /etc/apt/preferences.d/nosnap.pref <<EOF
# Prevent repository packages from triggering the installation of snap
Package: snapd
Pin: release a=*
Pin-Priority: -10
EOF

# Remove snapd and related packages
printf "${RED}Removing snapd and related packages...${NC}\n"
apt-get purge -y snapd gnome-software-plugin-snap

# Delete remaining Snap directories
printf "${RED}Deleting Snap directories...${NC}\n"
rm -rfv ~/snap /snap /var/snap /var/lib/snapd /var/cache/snapd

# Reload systemd Daemons
systemctl daemon-reload

# Install Flatpak
printf "${GREEN}Installing Flatpak...${NC}\n"
add-apt-repository -y ppa:flatpak/stable
apt-get update
apt-get install -y flatpak gnome-software-plugin-flatpak

# Add Flathub repository
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

printf "${GREEN}Installation complete!${NC} It's recommended to reboot the system: 'sudo systemctl reboot'\n"
